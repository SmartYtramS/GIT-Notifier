1c1
< #! /usr/bin/env python
---
> #!/usr/bin/env python
2a3,9
> '''
> This is a fork of ICIR.org git-notifier that implements colorized diff support
> plus some other nice things.
> Please refer to https://github.com/tb0hdan/GIT-Notifier for more detail.
> '''
> 
> # pylint: disable=C0103,C0302
11a19,31
> import smtplib
> from re import sub as re_sub, search as re_search, split as re_split
> from email.mime.multipart import MIMEMultipart
> from email.mime.text import MIMEText
> 
> try:
>     from pygments import highlight
>     from pygments.lexers import DiffLexer # pylint: disable=E0611
>     from pygments.formatters import HtmlFormatter # pylint: disable=E0611
>     pygments_available = True
> except ImportError:
>     pygments_available = False
> 
16c36,37
< Separator = "\n>---------------------------------------------------------------\n"
---
> Separator = "\n>%s\n" % ('-' * 62)
> Separhtml = "<hr>"
19a41
> 
26c48,51
<     ("allchanges", True, set(), "branches for which *all* changes are to be reported"),
---
>     ("allchanges", True, set(),
>      "branches for which *all* changes are to be reported"),
>     ("altsubject", False, False,
>      "enables alternative subject with repository name"),
30c55,56
<     ("hostname", True, socket.gethostname(), "host where the repository is hosted"),
---
>     ("hostname", True, socket.gethostname(),
>      "host where the repository is hosted"),
33c59,64
<     ("manual", True, None, "notifiy for a manually given set of revisions"),
---
>     ("smtpserver", True, 'localhost', "tells SMTP server to use, host only"),
>     ("smtpport", True, 25, "sets SMTP port for SMTP server"),
>     ("smtplogin", True, None, "sets login for SMTP AUTH"),
>     ("smtppassword", True, None, "sets password for SMTP AUTH"),
>     ("smtpssl", False, False, "enables SSL for SMTP"),
>     ("manual", True, None, "notify for a manually given set of revisions"),
34a66
>     ("colordiff", False, False, "colorize diffs using pygments library"),
38c70,71
<     ("link", True, None, "Link to insert into mail, %s will be replaced with revision"),
---
>     ("link", True, None,
>      "Link to insert into mail, %s will be replaced with revision"),
42c75,76
<     ("mergediffs", True, set(), "branches for which complete merge diffs are to be included"),
---
>     ("mergediffs", True, set(),
>      "branches for which complete merge diffs are to be included"),
45c79,83
< class State:
---
> 
> class State(object):
>     '''
>     State class
>     '''
49a88,90
>         '''
>         Clear data structures
>         '''
57a99,101
>         '''
>         Write to cache file
>         '''
67c111
<             print >>out, "head", head, ref
---
>             print >> out, "head", head, ref
70c114
<             print >>out, "tag", tag, ref
---
>             print >> out, "tag", tag, ref
73c117
<             print >>out, "rev", rev
---
>             print >> out, "rev", rev
75,78d118
<         # No longer used.
<         #
<         # for rev in self.diffs:
<         #     print >>out, "diff", rev
80a121,123
>         '''
>         Read from cache file
>         '''
112c155,158
< class GitConfig:
---
> class GitConfig(object):
>     '''
>     GitConfig class
>     '''
115c161,163
<         self.maxdiffsize *= 1024 # KBytes to bytes.
---
>         # KBytes to bytes.
>         self.maxdiffsize *= 1024 # pylint: disable=E1101
> 
118c166,167
<             self.allchanges = set([head.strip() for head in self.allchanges.split(",")])
---
>             self.allchanges = \
>                 set([head.strip() for head in self.allchanges.split(",")])
121c170,172
<             self.mergediffs = set([head.strip() for head in self.mergediffs.split(",")])
---
>             # pylint: disable=E1101
>             self.mergediffs = \
>                 set([head.strip() for head in self.mergediffs.split(",")])
123c174
<         if not self.debug:
---
>         if not self.debug: # pylint: disable=E1101
136c187,189
< 
---
>         '''
>         Parse command line arguments
>         '''
150c203,204
<                 parser.add_option("--%s" % name, action=action, dest=name, default=defval, help=help)
---
>                 parser.add_option("--%s" % name, action=action, dest=name,
>                     default=defval, help=help)
154c208,209
<                 parser.add_option("--%s" % name, action="store", type=type, default=defval, dest=name, help=help)
---
>                 parser.add_option("--%s" % name, action="store", type=type,
>                     default=defval, dest=name, help=help)
164a220,222
>         '''
>         Read users from configuration file
>         '''
177a236,238
>         '''
>         Return git configuration
>         '''
180a242,571
> class Colorer(object):
>     '''
>     Simple class that uses Pygments library to provide colorized
>     output (full HTML) for diffs.
>     '''
>     def __init__(self):
>         self.result = ''
>         if pygments_available:
>             self.formatter = HtmlFormatter(linenos=True, full=True,
>                 encoding="utf-8")
>             self.lexerobj  = DiffLexer()
> 
>     def formatDiff(self, data=None):
>         '''
>         Format diff
>         '''
>         self.data = data
>         if self.data:
>             try:
>                 self.result = highlight(self.data, self.lexerobj,
>                     self.formatter)
>             except:
>                 self.result = data
>         return self.result
> 
>     def colorizeFile(self, fname=None, key_start=None, key_end=None):
>         '''
>         Colorizes input file. Result is HTML.
>         '''
>         if fname and os.path.exists(fname):
>             _f = open(fname, 'r+b')
>             _data = _f.read()
>             _f.close()
>             # We have data, good.
>             if (key_start == None) and (key_end == None):
>                 return self.formatDiff(_data)
>             else:
>                 # Since we have text file here such split works just fine.
>                 __trigger = False
>                 __result_data = ''
>                 for line in _data.split('\n'):
>                     if key_start and (re_search(key_start, line) != None):
>                         __trigger = True
>                     if key_end   and (re_search(key_end,   line) != None):
>                         __trigger = False
>                     if  __trigger:
>                         __result_data += line + '\n'
>                 return self.formatDiff(__result_data)
>         else:
>             return None
> 
> class PrettyHTML(object):
>     '''
>     Simple class to make 'git show' message look prettier
>     '''
>     def __init__(self, subject=None):
>         self.keywords = ['commit', 'Author:', 'Date:']
>         # If True all next messages are not checked against keywords
>         self.keywords_trigger = False
>         # Contains additional tags before the commit message
>         self.extra_tags = ''
>         # Mailto subject part
>         self.subject = subject
>         if not self.subject:
>             self.subject = 'Git commit'
> 
>     def transcode(self, line):
>         '''
>         Encodes characters to HTML
>         '''
>         line = line.replace('<', '&lt;').replace('>', '&gt;')
>         # Required for mailto subject encoding
>         line = line.replace(' ', '%20')
>         return line
> 
>     def make_bold(self, keyword, line):
>         '''
>         Makes text bold
>         '''
>         part1 = ''
>         part2 = ''
>         if (re_search(keyword, line) != None) and \
>             (self.keywords_trigger == False):
>             if re_search(':', keyword) == None:
>                 replacement = '%s:' % keyword
>             else:
>                 replacement = keyword
>             # commit replacement
>             if (keyword in self.keywords) and (not replacement[:1].isupper()):
>                 replacement = replacement[0].upper() + replacement[1:]
>             # git commit email
>             if re_search('[A|a]uthor', keyword) != None:
>                 try:
>                     part1 = re_split('<(.*)>', line)[0].strip()
>                     part2 = re_split('<(.*)>', line)[1].strip()
>                 except:
>                     log("Broken email?")
>                 if (part1 != '') and (part2 != ''):
>                     email = part2
>                     uri = '<a href="mailto:%s?subject=%s">&lt;%s&gt;</a>' % \
>                      (email, self.transcode(self.subject), email)
>                     line = part1 + ' ' + uri
>             line = line.replace(keyword, '<b>%s</b>' % replacement)
>             line = "<br>%s" % line
>         return line
> 
>     def convert(self, line):
>         '''
>         Convert 'git show' keywords
>         '''
>         replacements = 0
>         for keyword in self.keywords:
>             line_orig = line
>             line = self.make_bold(keyword, line)
>             if line != line_orig:
>                 replacements += 1
>         # No replacements were made, assume we have commit message
>         if replacements == 0:
>             if self.keywords_trigger == False:
>                 self.keywords_trigger = True
>                 self.extra_tags = '<br>'
>             else:
>                 # Only on-change lines should have extra tags
>                 self.extra_tags = ''
>             line = '%s<br><b>%s</b>' % (self.extra_tags, line)
>         return line
> 
> 
> class Mail(object):
>     '''
>     Simple class for notifications via SMTP
>     '''
>     def __init__(self, smtp_host, smtp_port, smtp_login,
>         smtp_password, smtp_usessl):
> 
>         self.smtp_host = smtp_host
>         self.smtp_port = smtp_port
>         self.smtp_login = smtp_login
>         self.smtp_password = smtp_password
>         self.smtp_usessl = smtp_usessl
>         # Create message container
>         # The correct MIME type is multipart/alternative.
>         self.msg = MIMEMultipart('alternative')
> 
> 
>     def addHeader(self, header, value, header_append=False):
>         '''
>         Adds message header
>         '''
>         # Verify presence of header
>         if self.msg[header]:
>             # Header already set, look out for recepient duplicates!
>             if not header_append:
>                 return False
>             del self.msg[header]
>         # Set message header
>         self.msg[header] = value
>         return True
> 
>     def addPart(self, content_type, content, encoding=None):
>         '''
>         Adds message part
>         '''
>         if encoding:
>             # Use specified encoding
>             part = MIMEText(content, content_type, encoding)
>         else:
>             # Fallback to us-ascii
>             part = MIMEText(content, content_type)
>         return part
> 
>     def attach(self, part):
>         '''
>         Attach message part
>         '''
>         self.msg.attach(part)
> 
>     def attachHtml(self, content):
>         '''
>         Attach HTML message
>         '''
>         part = self.addPart('html', content, 'utf8')
>         self.attach(part)
> 
>     def attachText(self, content):
>         '''
>         Attach text message
>         '''
>         part = self.addPart('plain', content)
>         self.attach(part)
> 
>     def getMessage(self):
>         '''
>         Return whole message (so far)
>         '''
>         return self.msg
> 
>     def send(self, smtp_sender, smtp_mailinglist, smtp_data):
>         '''
>         Send email via SMTP
>         '''
>         log("Sending email to %s" % smtp_mailinglist)
>         self.connection = smtplib.SMTP(self.smtp_host)
>         try:
>             # identify ourselves, prompting server for supported features
>             self.connection.ehlo()
> 
>             # Encrypt connection if both server supports it
>             # and self.smtp_usessl is True
>             if self.connection.has_extn('STARTTLS') and self.smtp_usessl:
>                 self.connection.starttls()
>                 # re-identify ourselves over TLS connection
>                 self.connection.ehlo()
> 
>             # Enable SMTP AUTH if both self.smtp_login and
>             # self.smtp_password are not empty.
>             if self.smtp_login and self.smtp_password:
>                 self.connection.login(self.smtp_login, self.smtp_password)
> 
>             # Send message
>             self.connection.sendmail(smtp_sender, smtp_mailinglist, smtp_data)
>         except:
>             # Status of message: delivery failed
>             return False
>         finally:
>             self.connection.quit()
>         # Status of message: delivery successful
>         return True
> 
> class MailWrapper(object):
>     '''
>     MailWrapper class provides high level interface to Mail class
>     '''
>     def __init__(self, mail_object):
>         self.mail = mail_object
>         self.text_message = ''
>         self.html_message = '<html>\n'
> 
>     def init(self, text='', html='<html>\n'):
>         '''
>         Start with reasonable defaults.
>         '''
>         self.text_message = text
>         self.html_message = html
> 
>     def sendFile(self, out, fname):
>         '''
>         Send file contents via SMTP
>         '''
>         out.close()
>         if Config.debug: # pylint: disable=E1101
>             for line in open(fname):
>                 print "    |", line,
>             print ""
>         else:
>             _f = open(fname, 'r+b')
>             _data = _f.read()
>             _f.close()
>             # pylint: disable=E1101
>             self.mail.send(Config.sender, Config.mailinglist, _data)
> 
>     def generateMailHeader(self, subject):
>         '''
>         Generates mail header
>         '''
>         # TODO: This function should be called only once during run.
>         repo = _getRepo()
>         # Reply-To equals to sender, if not set.
>         # pylint: disable=E1101
>         replyto = 'Reply-To: %s\n' % \
>             Config.replyto if Config.replyto else Config.sender
>         if Config.altsubject:
>             subject = ('Repository: %s Branch: %s ' % \
>                 (re_sub('ssh://(.+)/', '',repo), subject))
> 
>         # Set message headers
>         self.mail.addHeader('From', Config.sender)
>         self.mail.addHeader('To', Config.mailinglist)
>         # Allow only 'Subject' header replacement.
>         self.mail.addHeader('Subject',
>             Config.emailprefix + subject, header_append=True)
>         self.mail.addHeader('Reply-To', replyto)
>         self.mail.addHeader('X-Git-Repository', repo)
>         self.mail.addHeader('X-Mailer', Name + ' ' + VERSION)
> 
> 
>     def addTag(self, key, value):
>         '''
>         Adds message tag
>         '''
>         if Config.colordiff: # pylint: disable=E1101
>             formatted = '<br><b>%-11s:</b> %s\n' % (key, value)
>             self.addLine(formatted, html_only=True, start_br=False)
>         else:
>             formatted = '%-11s: %s' % (key, value)
>             self.addLine(formatted, text_only=True)
> 
>     def addLine(self, line, text_only=False, html_only=False, start_br=True):
>         '''
>         Adds message line
>         '''
>         if text_only:
>             self.text_message += line
>             return
>         if html_only:
>             if Config.colordiff: # pylint: disable=E1101
>                 if start_br:
>                     self.html_message += '<br>%s' % line
>                 else:
>                     self.html_message += line
>             return
>         # TODO: DRY!!!
>         self.text_message += line
>         if Config.colordiff: # pylint: disable=E1101
>             if start_br:
>                 self.html_message += '<br>%s' % line
>             else:
>                 self.html_message += line
> 
>     def getMessage(self):
>         '''
>         Returns whole message
>         '''
>         # Message parts should be always attached before returning the message.
>         self.mail.attachText(self.text_message)
>         if Config.colordiff: # pylint: disable=E1101
>             self.mail.attachHtml(self.html_message)
>         return self.mail.getMessage()
> 
> 
182c573,576
<     print >>Config.log, "%s - %s" % (time.asctime(), msg)
---
>     '''
>     Shows message to remote party
>     '''
>     print >> Config.log, "%s - %s" % (time.asctime(), msg)
184a579,581
>     '''
>     Uses log() function to notify remote party of errors
>     '''
188a586,588
>     '''
>     Provides pythonic interface to git executable
>     '''
193,194c593,594
<         if Config.debug:
<             print >>sys.stderr, "> git " + args
---
>         if Config.debug: # pylint: disable=E1101
>             print >> sys.stderr, "> git " + args
200c600,601
<         child = subprocess.Popen("git " + args, shell=True, stdin=None, stdout=stdout_to, stderr=subprocess.PIPE)
---
>         child = subprocess.Popen("git " + args, shell=True, stdin=None,
>             stdout=stdout_to, stderr=subprocess.PIPE)
217a619,621
>     '''
>     Retrieves information about repository heads
>     '''
224a629,631
>     '''
>     Retrieves information about repository tags
>     '''
231c638
<                 tag= tag[10:]
---
>                 tag = tag[10:]
235a643,646
>     '''
>     Retrieves information about reachable repository revisions.
>     Result is an array.
>     '''
239a651,653
>     '''
>     Read current state from file.
>     '''
249a664,666
>     '''
>     Create temporary files
>     '''
257a675,677
>     '''
>     Delete temporary files
>     '''
261,267c681,685
< def mailTag(key, value):
<     return "%-11s: %s" % (key, value)
< 
< def generateMailHeader(subject):
< 
<     repo = Config.repouri
< 
---
> def _getRepo():
>     '''
>     Retrieve repository path
>     '''
>     repo = Config.repouri # pylint: disable=E1101
269d686
< 
272c689,691
<             repo = "ssh://%s@%s/%s" % (whoami, Config.hostname, os.path.basename(os.getcwd()))
---
>             # pylint: disable=E1101
>             repo = "ssh://%s@%s/%s" % (whoami, Config.hostname,
>                 os.path.basename(os.getcwd()))
275,276c694,696
<             repo = "ssh://%s/%s" % (Config.hostname, os.path.basename(os.getcwd()))
< 
---
>             # pylint: disable=E1101
>             repo = "ssh://%s/%s" % (Config.hostname,
>                 os.path.basename(os.getcwd()))
278a699
>     return repo
280,314d700
<     (out, fname) = makeTmp()
< 
<     replyto = "Reply-To: %s\n" % Config.replyto if Config.replyto else ""
< 
<     print >>out, """From: %s
< To: %s
< Subject: %s %s
< %sX-Git-Repository: %s
< X-Mailer: %s %s
< 
< %s
< 
< """ % (Config.sender, Config.mailinglist, Config.emailprefix, subject, replyto, repo,
<        Name, VERSION, mailTag("Repository", repo)),
< 
<     return (out, fname)
< 
< def sendMail(out, fname):
<     out.close()
< 
<     if Config.debug:
<         for line in open(fname):
<             print "    |", line,
<         print ""
<     else:
<         stdin = subprocess.Popen("/usr/sbin/sendmail -t", shell=True, stdin=subprocess.PIPE).stdin
<         for line in open(fname):
<             print >>stdin, line,
<         stdin.close()
< 
<     # Wait a bit in case we're going to send more mails. Otherwise, the mails
<     # get sent back-to-back and are likely to end up with identical timestamps,
<     # which may then make them appear to have arrived in the wrong order.
<     if not Config.debug:
<         time.sleep(2)
316a703,705
>     '''
>     Hook for adding an entry
>     '''
317a707
>     (out, fname) = makeTmp()
319,324c709,718
<     (out, fname) = generateMailHeader("%s '%s' created" % (key, value))
< 
<     print >>out, mailTag("New %s" % key, value)
<     print >>out, mailTag("Referencing", rev)
< 
<     sendMail(out, fname)
---
>     # Start with empty message
>     message.init()
>     message.generateMailHeader("%s '%s' created" % (key, value))
> 
>     message.addTag("New %s" % key, value)
>     message.addTag("Referencing", rev)
> 
>     # print whole message to file
>     print >> out, message.getMessage()
>     message.sendFile(out, fname)
326a721,723
>     '''
>     Hook for deleting an entry
>     '''
327a725
>     (out, fname) = makeTmp()
329,333c727,735
<     (out, fname) = generateMailHeader("%s '%s' deleted" % (key, value))
< 
<     print >>out, mailTag("Deleted %s" % key, value)
< 
<     sendMail(out, fname)
---
>     # Start with empty message
>     message.init()
>     message.generateMailHeader("%s '%s' deleted" % (key, value))
> 
>     message.addTag("Deleted %s" % key, value)
> 
>     # print whole message to file
>     print >> out, message.getMessage()
>     message.sendFile(out, fname)
335,336d736
< # Sends a mail for a notification consistent of two parts: (1) the output of a
< # show command, and (2) the output of a diff command.
338,339c738,750
< 
<     (out, fname) = generateMailHeader(subject)
---
>     '''
>     Sends a mail for a notification consistent of two parts: (1) the output of
>     a show command, and (2) the output of a diff command.
>     '''
>     repo = _getRepo()
>     # The 'git show' prettifier
>     prettyhtml = PrettyHTML(subject='Git commit %s' % subject[-9:])
>     # Start with empty message
>     message.init()
>     message.generateMailHeader(subject)
>     (out, fname) = makeTmp()
>     #
>     message.addTag("Repository", repo)
344c755
<     print >>out, mailTag("On branch%s" % multi, heads)
---
>     message.addTag("On branch%s" % multi, heads)
346,348c757,759
<     if Config.link:
<         url = Config.link.replace("%s", rev)
<         print >>out, mailTag("Link", url)
---
>     if Config.link: # pylint: disable=E1101
>         url = Config.link.replace("%s", rev) # pylint: disable=E1101
>         message.addTag("Link", url)
366,368c777,779
< 
<         if size > Config.maxdiffsize:
<             footer = "\nDiff suppressed because of size. To see it, use:\n\n    git %s" % diff_cmd
---
>         if size > Config.maxdiffsize: # pylint: disable=E1101
>             footer = "\nDiff suppressed because of size.\n \
>                 To see it, use:\n\n    git %s" % diff_cmd
371c782,784
<     print >>out, Separator
---
>     message.addLine(Separator, text_only=True)
>     # Use nice <hr> in html mode
>     message.addLine(Separhtml, html_only=True)
375c788,789
<             print >>out, Separator
---
>             message.addLine(Separator, text_only=True)
>             message.addLine(Separhtml, html_only=True)
377c791,793
<             print >>out, line
---
>             message.addLine(line + "\n", text_only=True)
>             message.addLine(prettyhtml.convert(line) + "\n",
>                 html_only=True, start_br=False)
379c795,796
<     print >>out, Separator
---
>     message.addLine(Separator, text_only=True)
>     message.addLine(Separhtml, html_only=True)
380a798
>     # Text only, read diff from file
383,385c801
<             print >>out, line,
< 
<     print >>out, footer
---
>             message.addLine(line, text_only=True)
387,390c803,823
<     if Config.debug:
<         print >>out, "-- "
<         print >>out, "debug: show_cmd = git %s" % show_cmd
<         print >>out, "debug: diff_cmd = git %s" % diff_cmd
---
>     # HTML only, read and parse diff
>     if Config.colordiff and tname: # pylint: disable=E1101
>         colorer = Colorer()
>         message.addLine('\n', html_only=True, start_br=False)
>         message.addLine(colorer.colorizeFile(tname, key_start='diff\ --git'),
>             html_only=True, start_br=False)
> 
>     message.addLine(footer, text_only=True)
>     message.addLine(footer.replace("\n", "<br>\n"), html_only=True)
> 
>     if Config.debug: # pylint: disable=E1101
>         message.addLine("-- ", text_only=True)
>         # Use nice <hr> in html mode
>         message.addLine(Separhtml, html_only=True)
>         # Both text and html
>         message.addLine("debug: show_cmd = git %s" % show_cmd)
>         message.addLine("debug: diff_cmd = git %s" % diff_cmd)
> 
>     # print whole message to file
>     print >> out, message.getMessage()
>     message.sendFile(out, fname)
392,394d824
<     sendMail(out, fname)
< 
< # Sends notification for a specific revision.
395a826,828
>     '''
>     Sends notification for a specific revision.
>     '''
398c831,832
<         log("Flagged revision %s for notification, but already reported this time" % rev)
---
>         log("Flagged revision %s for notification, \
>             but already reported this time" % rev)
417,418c851,854
<     show_cmd = "show -s --no-color --find-copies-harder --pretty=medium %s" % rev
<     diff_cmd = "diff-tree --patch-with-stat --no-color --find-copies-harder --ignore-space-at-eol %s %s" % (merge_diff, rev)
---
>     show_cmd = "show -s --no-color --find-copies-harder \
>         --pretty=medium %s" % rev
>     diff_cmd = "diff-tree --patch-with-stat --no-color --find-copies-harder \
>         --ignore-space-at-eol %s %s" % (merge_diff, rev)
422,424d857
< # Sends a diff between two revisions.
< #
< # Only used in manual mode now.
425a859,862
>     '''
>     Sends a diff between two revisions.
>     Only used in manual mode now.
>     '''
439,440c876,879
<     show_cmd = "show -s --no-color --find-copies-harder --pretty=medium %s" % last
<     diff_cmd = "diff --patch-with-stat -m --no-color --find-copies-harder --ignore-space-at-eol %s %s" % (first, last)
---
>     show_cmd = "show -s --no-color --find-copies-harder \
>         --pretty=medium %s" % last
>     diff_cmd = "diff --patch-with-stat -m --no-color --find-copies-harder \
>         --ignore-space-at-eol %s %s" % (first, last)
444,447d882
< # Sends pair-wise diffs for a path of revisions. Also records all revision on
< # the path as seen.
< #
< # Only used in manual mode now.
448a884,888
>     '''
>     Sends pair-wise diffs for a path of revisions. Also records all revision on
>     the path as seen.
>     Only used in manual mode now.
>     '''
456d895
< # Sends a commit notifications for a set of revisions.
457a897,900
>     '''
>     Sends a commit notifications for a set of revisions.
>     '''
> 
467d909
< # Sends a summary mail for a set of revisions.
468a911,913
>     '''
>     Sends a summary mail for a set of revisions.
>     '''
469a915
>     (out, fname) = makeTmp()
473c919,921
<     (out, fname) = generateMailHeader("%s's head updated: %s" % (head, subject[0]))
---
>     # Start with empty message
>     message.init()
>     message.generateMailHeader("%s's head updated: %s" % (head, subject[0]))
475,476c923,924
<     print >>out, "Branch '%s' now includes:" % head
<     print >>out, ""
---
>     message.addLine("Branch '%s' now includes:" % head)
>     message.addLine("")
479c927,928
<         print >>out, "    ", git("show -s --pretty=oneline --abbrev-commit %s" % rev)[0]
---
>         message.addLine("    " +
>             str(git("show -s --pretty=oneline --abbrev-commit %s" % rev)[0]))
481c930,932
<     sendMail(out, fname)
---
>     # print whole message to file
>     print >> out, message.getMessage()
>     message.sendFile(out, fname)
483a935,939
> # pylint: disable=E1101
> mail = Mail(Config.smtpserver, Config.smtpport,
>             Config.smtplogin, Config.smtppassword, Config.smtpssl)
> #
> message = MailWrapper(mail)
489c945
<         print >>sys.stderr, "[Option %s: %s]" % (name, Config.__dict__[name])
---
>         print >> sys.stderr, "[Option %s: %s]" % (name, Config.__dict__[name])
561c1017,1018
<         path = git(["rev-list", "--reverse --date-order", new_rev, "^%s" % old_rev])
---
>         path = git(["rev-list",
>             "--reverse --date-order", new_rev, "^%s" % old_rev])
